<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cafeter√≠a JAVA</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Encabezado -->
  <header>
    <h1><i class="fa-solid fa-mug-saucer" style="color: #ffffff;"></i> Cafeter√≠a JAVA</h1>
    <nav>
      <a href="Inicio.html">Inicio</a>
      <a href="#" class="activo">Pedidos</a>
      <a href="Inventario/inventario_menu.html">Inventario</a>
      <a href="Panel.html">Panel</a>
      <a href="InicioSesion.html">Cerrar sesion</a>
    </nav>
  </header>

  <!-- Contenido principal -->
  <main class="container">
    <h2>Pedidos</h2>
    <div class="cards">

         <!-- para ayudar a variables-->
      <div class="card" data-id="1">
        <img src="https://png.pngtree.com/png-vector/20250327/ourmid/pngtree-assorted-coffee-cups-including-cappuccino-cup-with-heart-png-image_15878581.png" alt="Caf√© con leche">
        <h3 class="producto-nombre">Caf√© con leche</h3>
         <p class="producto-precio">Precio: $45</p> 
        <div class="cantidad-control"> 
         <label for="cantidad-cafe-leche">Cantidad:</label>
        <input type="number" value="0" min="0" class="producto-cantidad" id="cantidad-cafe-leche">
        <div class="buttons">
          <button class="edit">‚úèÔ∏è</button>
          <button class="ok">‚úî</button>
          <button class="delete">‚ùå</button>
        </div>
        </div>
      </div>
        <!--Fin a√±adido-->
      <div class="card" data-id="2">
        <img src="https://www.shutterstock.com/image-photo/foamy-coffee-cappuccino-wiped-milk-600nw-2478573231.jpg" alt="Capuchino">
        <h3 class="producto-nombre">Capuchino</h3>
        <p class="producto-precio">Precio: $40</p>
         <div class="cantidad-control"> 
         <label for="cantidad-capuchino">Cantidad:</label>
        <input type="number" value="0" min="0" class="producto-cantidad" id="cantidad-capuchino">
        <div class="buttons">
          <button class="edit">‚úèÔ∏è</button>
          <button class="ok">‚úî</button>
          <button class="delete">‚ùå</button>
        </div>
         </div>
      </div>

      <div class="card" data-id="3">
        <img src="https://png.pngtree.com/png-vector/20250322/ourmid/pngtree-layered-coffee-drink-png-image_15844904.png" alt="Caf√© helado">
        <h3 class="producto-nombre">Caf√© helado</h3>
        <p class="producto-precio">Precio: $50</p>
        <div class="cantidad-control">
          <label for="cantidad-Cafe-helado">Cantidad:</label>
          <input type="number" value="0" min="0" class="producto-cantidad" id="cantidad-Cafe-helado">
        <div class="buttons">
          <button class="edit">‚úèÔ∏è</button>
          <button class="ok">‚úî</button>
          <button class="delete">‚ùå</button>
        </div>
      </div>
      </div>

      <div class="card" data-id="4">
        <img src="https://www.starbucksathome.com/mx/sites/default/files/2021-03/3-CaffeAmericano_LongShadow_Cream_1.png" alt="Caf√© americano">
        <h3 class="producto-nombre">Caf√© Americano</h3>
        <p class="producto-precio">Precio: $30</p>
        <div class="cantidad-control">
          <label for="cantidad-cafe-americano">Cantidad:</label>
          <input type="number" value="0" min="0" class="producto-cantidad" id="cantidad-cafe-americano">
        <div class="buttons">
          <button class="edit">‚úèÔ∏è</button>
          <button class="ok">‚úî</button>
          <button class="delete">‚ùå</button>
        </div>
      </div>
      </div>

      <div class="card" data-id="5">
        <img src="https://www.cocinadelirante.com/800x600/filters:format(webp):quality(75)/sites/default/files/images/2024/11/prepara-chocolate-caliente-con-bombones-y-alivia-la-tos.jpg" alt="Chocolate caliente">
        <h3 class="producto-nombre">Chocolate caliente</h3>
        <p class="producto-precio">Precio: $35</p>
        <div class="cantidad-control">
          <label for="cantidad-chocolate-caliente">Cantidad:</label>
          <input type="number" value="0" min="0" class="producto-cantidad" id="cantidad-chocolate-caliente">
        <div class="buttons">
          <button class="edit">‚úèÔ∏è</button>
          <button class="ok">‚úî</button>
          <button class="delete">‚ùå</button>
        </div>
        </div>
      </div>

      <div class="card" data-id="6">
        <img src="https://app.nutrium.com/rails/active_storage/blobs/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBM01kS2c9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--f11d81b72b83d24788c11ed5c66617469662f000/Pan%20Pita%20Wrap%20de%20Pollo.png" alt="Wrap de pollo">
        <h3 class="producto-nombre">Wrap de pollo</h3>
        <p class="producto-precio">Precio: $80</p>
        <div class="cantidad-control">
          <label for="cantidad-wrap-pollo">Cantidad:</label>
          <input type="number" value="0" min="0" class="producto-cantidad" id="cantidad-wrap-pollo">
        <div class="buttons">
          <button class="edit">‚úèÔ∏è</button>
          <button class="ok">‚úî</button>
          <button class="delete">‚ùå</button>
        </div>
        </div>
      </div>
    </div>

    <div class="actions">
      <!--seleccionar mesa-->
      <div class="mesa-selector-container">
        <label for="selectMesa">Mesa/Cliente</label>
        <select id="selectMesa">
          <option value="1">Mesa 1</option>
          <option value="2">Mesa 2</option>
          <option value="3">Mesa 3</option>
          <option value="4">Mesa 4</option>
          <option value="5">Mesa 5</option>
          <option value="6">Para Llevar/Barra</option>
        </select>
      </div>

      <!--<button class="add">Agregar m√°s pedidos</button>-->
      <!--<button class="report">Generar reporte de ventas</button>-->
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <p>¬© 2025 Cafeter√≠a JAVA. Todos los derechos reservados.</p>
      <div class="footer-links">
        <a href="politica_privacidad.html">Pol√≠tica de privacidad</a> |
        <a href="condiciones_servicio.html">Condiciones de servicio</a> |
        <a href="preguntas_frecuentes.html">Preguntas frecuentes</a>
      </div>
    </div>
  </footer>
   <!--modal-->
  <div id="resumenModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>Resumen de Pedido</h3>
        <ul id="listaPedidoModal">
            </ul>
        <div class="modal-footer">
            <p><strong>Total:</strong> <span id="totalModal"></span></p>
        </div>
        <button id="seguirAgregando" class="add">A√±adir o Actualizar Productos</button>
        <button id="cerrarYConfirmar" class="report">Cerrar y Confirmar</button>
    </div>
</div>
  <!--FinModal-->
  <script>
    // Variable para almacenar los productos del pedido
let pedidoActual = [];

// Referencias al Modal
const resumenModal = document.getElementById('resumenModal');
const listaPedidoModal = document.getElementById('listaPedidoModal');
const totalModal = document.getElementById('totalModal');
const closeButton = document.querySelector('.close-button');
const cerrarYConfirmarButton = document.getElementById('cerrarYConfirmar');
// Referencias al Nuevo Bot√≥n
const seguirAgregandoButton = document.getElementById('seguirAgregando'); // ¬°A√ëADIDO!

// ... el resto de tu script ...

// Funci√≥n para actualizar y mostrar el Modal
function mostrarResumenPedido() {
    listaPedidoModal.innerHTML = ''; // Limpiar lista anterior
    let total = 0;

    if (pedidoActual.length === 0) {
        listaPedidoModal.innerHTML = '<li>No hay productos en el pedido.</li>';
        totalModal.textContent = '$0.00';
    } else {
        pedidoActual.forEach(item => {
            // Convertir precio a n√∫mero decimal y calcular subtotal
            const precioNumero = parseFloat(item.precio.replace('Precio: $', '').trim());
            const subtotal = precioNumero * item.cantidad;
            total += subtotal;

            const li = document.createElement('li');
            li.innerHTML = `
                ${item.nombre} (x${item.cantidad}) - 
                $${precioNumero.toFixed(2)} c/u = 
                $${subtotal.toFixed(2)}
            `;
            listaPedidoModal.appendChild(li);
        });

        totalModal.textContent = `$${total.toFixed(2)}`;
    }
    
    resumenModal.style.display = 'block'; // Mostrar el modal
}

// L√≥gica para cerrar el Modal
closeButton.addEventListener('click', () => {
    resumenModal.style.display = 'none';
});


//segunda version
// ...existing code...

cerrarYConfirmarButton.addEventListener('click', async () => {
  if (pedidoActual.length === 0) {
    alert('El pedido est√° vac√≠o. No hay nada que confirmar.');
    resumenModal.style.display = 'none';
    return;
  }  
  const idMesa = document.getElementById('selectMesa').value;

  let total=0;
  const productosParaDB = pedidoActual.map(item => {
        const precioNumero = parseFloat(item.precio.replace('Precio: $', '').trim());
        const subtotal = precioNumero * item.cantidad;
        total += subtotal;

        return {
            id: item.idProducto, 
            cantidad: item.cantidad,
            subtotal: parseFloat(subtotal.toFixed(2))
        };
    });
    // Construir el objeto principal del pedido
    const pedidoData = {
        // üö® IdCliente: Se toma de la selecci√≥n de Mesa
        idCliente: parseInt(idMesa, 10), 
        // IdUsuario: Se toma de la sesi√≥n de Login
        idUsuario: parseInt(localStorage.getItem('usuarioId') || '1', 10), 
        total: parseFloat(total.toFixed(2)),
        productos: productosParaDB
    };
    
    // Validaci√≥n de seguridad (opcional pero recomendada)
    if (isNaN(pedidoData.idUsuario)) {
        alert('Error: No se pudo identificar al empleado (ID de usuario no encontrado).');
        return;
    }

    try {
        const response = await fetch('http://localhost:3000/api/pedidos', {
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(pedidoData) 
        });

        const data = await response.json();

        if (response.ok && data.success) {
            // √âxito: El backend se encarg√≥ de las tablas Pedidos y DetallePedidos.
            alert(`‚úÖ Pedido #${data.idPedido} (Mesa ${idMesa}) guardado con √©xito.`);
            
            // Limpieza y cierre
            pedidoActual = []; 
            document.querySelectorAll('.producto-cantidad').forEach(input => { input.value = 0; });
            resumenModal.style.display = 'none';
        } else {
            alert(`‚ùå Error al guardar el pedido: ${data.message || 'Error desconocido.'}`);
        }

    } catch (error) {
        console.error('Error de conexi√≥n con el servidor:', error);
        alert('‚ùå Error de conexi√≥n. Aseg√∫rate de que tu servidor (node server.js) est√© corriendo.');
    }
});
  /*resumenModal.style.display = 'none';
    alert('Pedido Finalizado y Confirmado.');
    pedidoActual = []; // Vaciar el pedido

    // Reiniciar los valores de cantidad en todas las tarjetas
    document.querySelectorAll('.producto-cantidad').forEach(input => {
        input.value = 0;
    });
});*/

// ...existing code...

// Cerrar modal si el usuario hace clic fuera de √©l
window.addEventListener('click', (event) => {
    if (event.target === resumenModal) {
        resumenModal.style.display = 'none';
    }
});
// L√≥gica del nuevo bot√≥n "A√±adir M√°s Productos" (¬°NUEVO!)
seguirAgregandoButton.addEventListener('click', () => {
    resumenModal.style.display = 'none';
    // Importante: NO vaciamos el pedidoActual, solo cerramos el modal.
});
    //fin weas modal

    // Funcionalidad b√°sica de botones
    const editButtons = document.querySelectorAll('.edit');
    const deleteButtons = document.querySelectorAll('.delete');
    const okButtons = document.querySelectorAll('.ok');

       //modificado
    okButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        // 1. Obtener la tarjeta padre para encontrar los datos
        const card = btn.closest('.card');
        
        // 2. Extraer la informaci√≥n usando las clases que a√±adimos
        const idProducto= parseInt(card.dataset.id, 10); // Si necesitas el ID
        const nombreElement = card.querySelector('.producto-nombre');
        const precioElement = card.querySelector('.producto-precio');
        const cantidadInput = card.querySelector('.producto-cantidad');

        // Validaci√≥n: Asegurarse de que todos los elementos existan
        if (!nombreElement || !precioElement || !cantidadInput || !idProducto) {
            alert('Error: Faltan elementos de datos en la tarjeta (nombre/precio/cantidad).');
            return;
        }

        const nombre = nombreElement.textContent.trim();
        const precioTexto = precioElement.textContent.trim(); // Ej: "Precio: $45"
        const cantidad = parseInt(cantidadInput.value, 10);
        
        // Validaci√≥n de cantidad
        if (cantidad < 1 || isNaN(cantidad)) {
            alert('La cantidad debe ser un n√∫mero positivo.');
            return;
        }

        // 3. Crear el objeto producto
        const producto = {
          idProducto: idProducto,
          nombre: nombre,
          precio: precioTexto, 
          cantidad: cantidad
        };

        // 4. A√±adir o actualizar al pedido actual
        const itemExistente = pedidoActual.find(item => item.nombre === nombre);
        if (itemExistente) {
            // Si ya existe, SUMAR la cantidad actual (si el usuario la volvi√≥ a agregar)
            itemExistente.cantidad += cantidad;
        } else {
            // Si es un producto nuevo, lo a√±adimos
            pedidoActual.push(producto);
        }
        
        // 5. Mostrar el modal con el resumen del pedido
        mostrarResumenPedido();
    });
});
    //fin modificado
    //piwas version
    

editButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    // 1. Obtener la tarjeta padre
    const card = btn.closest('.card');
    const nombreElement = card.querySelector('.producto-nombre');
    const cantidadInput = card.querySelector('.producto-cantidad');

    if (!nombreElement || !cantidadInput) {
      alert('Error: No se encontr√≥ el producto o cantidad.');
      return;
    }

    const nombre = nombreElement.textContent.trim();
    const nuevaCantidad = parseInt(cantidadInput.value, 10);

    if (isNaN(nuevaCantidad) || nuevaCantidad < 1) {
      alert('La cantidad debe ser mayor a 0.');
      return;
    }

    // 2. Buscar el producto en el pedidoActual y actualizar la cantidad
    const productoEnPedido = pedidoActual.find(item => item.nombre === nombre);
    if (productoEnPedido) {
      productoEnPedido.cantidad = nuevaCantidad;
      mostrarResumenPedido(); // Refresca el modal con la nueva cantidad
      alert('Cantidad actualizada en el resumen.');
    } else {
      alert('Este producto a√∫n no est√° en el pedido. Conf√≠rmalo primero con ‚úî.');
    }
  });
});

deleteButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    // 1. Obtener la tarjeta padre
    const card = btn.closest('.card');
    const nombreElement = card.querySelector('.producto-nombre');
    if (!nombreElement) {
      alert('Error: No se encontr√≥ el producto.');
      return;
    }
    const nombre = nombreElement.textContent.trim();

    // 2. Eliminar del array pedidoActual
    const index = pedidoActual.findIndex(item => item.nombre === nombre);
    if (index !== -1) {
      pedidoActual.splice(index, 1); // Elimina el producto del pedido
      mostrarResumenPedido(); // Actualiza el modal
      alert('Producto eliminado del resumen.');
    } else {
      alert('Este producto no est√° en el pedido.');
    }
  });
});

  </script>
 
</body>
</html>
