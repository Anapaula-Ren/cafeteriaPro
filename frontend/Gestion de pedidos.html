<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CafeterÃ­a JAVA</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Barra superior -->
  <header class="navbar">
    <div class="logo">â˜• CafeterÃ­a JAVA</div>
    <nav>
      <a href="Inicio.html">Inicio</a>
      <a href="Gestion de pedidos.html">Pedidos</a>
      <a href="Inventario/inventario_menu.html">Inventario</a>
      <a href="#">Panel</a>
    </nav>
  </header>

  <!-- Contenido principal -->
  <main class="container">
    <h2>Pedidos</h2>
    <div class="cards">

         <!-- para ayudar a variables-->
      <div class="card" data-id="1">
        <img src="https://png.pngtree.com/png-vector/20250327/ourmid/pngtree-assorted-coffee-cups-including-cappuccino-cup-with-heart-png-image_15878581.png" alt="CafÃ© con leche">
        <h3 class="producto-nombre">CafÃ© con leche</h3>
         <p class="producto-precio">Precio: $45</p> 
        <div class="cantidad-control"> 
         <label for="cantidad-cafe-leche">Cantidad:</label>
        <input type="number" value="0" min="0" class="producto-cantidad" id="cantidad-cafe-leche">
        <div class="buttons">
          <button class="edit">âœï¸</button>
          <button class="ok">âœ”</button>
          <button class="delete">âŒ</button>
        </div>
        </div>
      </div>
        <!--Fin aÃ±adido-->
      <div class="card" data-id="2">
        <img src="https://www.shutterstock.com/image-photo/foamy-coffee-cappuccino-wiped-milk-600nw-2478573231.jpg" alt="Capuchino">
        <h3 class="producto-nombre">Capuchino</h3>
        <p class="producto-precio">Precio: $40</p>
         <div class="cantidad-control"> 
         <label for="cantidad-capuchino">Cantidad:</label>
        <input type="number" value="0" min="0" class="producto-cantidad" id="cantidad-capuchino">
        <div class="buttons">
          <button class="edit">âœï¸</button>
          <button class="ok">âœ”</button>
          <button class="delete">âŒ</button>
        </div>
         </div>
      </div>

      <div class="card" data-id="3">
        <img src="https://png.pngtree.com/png-vector/20250322/ourmid/pngtree-layered-coffee-drink-png-image_15844904.png" alt="CafÃ© helado">
        <h3 class="producto-nombre">CafÃ© helado</h3>
        <p class="producto-precio">Precio: $50</p>
        <div class="cantidad-control">
          <label for="cantidad-Cafe-helado">Cantidad:</label>
          <input type="number" value="0" min="0" class="producto-cantidad" id="cantidad-Cafe-helado">
        <div class="buttons">
          <button class="edit">âœï¸</button>
          <button class="ok">âœ”</button>
          <button class="delete">âŒ</button>
        </div>
      </div>
      </div>

      <div class="card" data-id="4">
        <img src="https://www.starbucksathome.com/mx/sites/default/files/2021-03/3-CaffeAmericano_LongShadow_Cream_1.png" alt="CafÃ© americano">
        <h3 class="producto-nombre">CafÃ© Americano</h3>
        <p class="producto-precio">Precio: $30</p>
        <div class="cantidad-control">
          <label for="cantidad-cafe-americano">Cantidad:</label>
          <input type="number" value="0" min="0" class="producto-cantidad" id="cantidad-cafe-americano">
        <div class="buttons">
          <button class="edit">âœï¸</button>
          <button class="ok">âœ”</button>
          <button class="delete">âŒ</button>
        </div>
      </div>
      </div>

      <div class="card" data-id="5">
        <img src="https://www.cocinadelirante.com/800x600/filters:format(webp):quality(75)/sites/default/files/images/2024/11/prepara-chocolate-caliente-con-bombones-y-alivia-la-tos.jpg" alt="Chocolate caliente">
        <h3 class="producto-nombre">Chocolate caliente</h3>
        <p class="producto-precio">Precio: $35</p>
        <div class="cantidad-control">
          <label for="cantidad-chocolate-caliente">Cantidad:</label>
          <input type="number" value="0" min="0" class="producto-cantidad" id="cantidad-chocolate-caliente">
        <div class="buttons">
          <button class="edit">âœï¸</button>
          <button class="ok">âœ”</button>
          <button class="delete">âŒ</button>
        </div>
        </div>
      </div>

      <div class="card" data-id="6">
        <img src="https://app.nutrium.com/rails/active_storage/blobs/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBM01kS2c9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--f11d81b72b83d24788c11ed5c66617469662f000/Pan%20Pita%20Wrap%20de%20Pollo.png" alt="Wrap de pollo">
        <h3 class="producto-nombre">Wrap de pollo</h3>
        <p class="producto-precio">Precio: $80</p>
        <div class="cantidad-control">
          <label for="cantidad-wrap-pollo">Cantidad:</label>
          <input type="number" value="0" min="0" class="producto-cantidad" id="cantidad-wrap-pollo">
        <div class="buttons">
          <button class="edit">âœï¸</button>
          <button class="ok">âœ”</button>
          <button class="delete">âŒ</button>
        </div>
        </div>
      </div>
    </div>

    <div class="actions">
      <!--seleccionar mesa-->
      <label for="selectMesa">Mesa/Cliente:</label>
  <select id="selectMesa">
      <option value="1">Mesa 1</option>
      <option value="2">Mesa 2</option>
      <option value="3">Mesa 3</option>
      <option value="4">Mesa 4</option>
      <option value="5">Mesa 5</option>
      <option value="6">Para Llevar/Barra</option>
  </select>

      <button class="add">Agregar pedido</button>

      <!--<button class="add">Agregar mÃ¡s pedidos</button>-->
      <!--<button class="report">Generar reporte de ventas</button>-->
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <p>Â© 2025 CafeterÃ­a JAVA. Todos los derechos reservados.</p>
      <div class="footer-links">
        <a href="#">polÃ­tica de privacidad</a> |
        <a href="#">Condiciones de servicio</a> |
        <a href="#">Preguntas frecuentes</a>
      </div>
    </div>
  </footer>
   <!--modal-->
  <div id="resumenModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>Resumen de Pedido</h3>
        <ul id="listaPedidoModal">
            </ul>
        <div class="modal-footer">
            <p><strong>Total:</strong> <span id="totalModal"></span></p>
        </div>
        <button id="seguirAgregando" class="add">AÃ±adir o Actualizar Productos</button>
        <button id="cerrarYConfirmar" class="report">Cerrar y Confirmar</button>
    </div>
</div>
  <!--FinModal-->
  <script>
    // Variable para almacenar los productos del pedido
let pedidoActual = [];

// Referencias al Modal
const resumenModal = document.getElementById('resumenModal');
const listaPedidoModal = document.getElementById('listaPedidoModal');
const totalModal = document.getElementById('totalModal');
const closeButton = document.querySelector('.close-button');
const cerrarYConfirmarButton = document.getElementById('cerrarYConfirmar');
// Referencias al Nuevo BotÃ³n
const seguirAgregandoButton = document.getElementById('seguirAgregando'); // Â¡AÃ‘ADIDO!

// ... el resto de tu script ...

// FunciÃ³n para actualizar y mostrar el Modal
function mostrarResumenPedido() {
    listaPedidoModal.innerHTML = ''; // Limpiar lista anterior
    let total = 0;

    if (pedidoActual.length === 0) {
        listaPedidoModal.innerHTML = '<li>No hay productos en el pedido.</li>';
        totalModal.textContent = '$0.00';
    } else {
        pedidoActual.forEach(item => {
            // Convertir precio a nÃºmero decimal y calcular subtotal
            const precioNumero = parseFloat(item.precio.replace('Precio: $', '').trim());
            const subtotal = precioNumero * item.cantidad;
            total += subtotal;

            const li = document.createElement('li');
            li.innerHTML = `
                ${item.nombre} (x${item.cantidad}) - 
                $${precioNumero.toFixed(2)} c/u = 
                $${subtotal.toFixed(2)}
            `;
            listaPedidoModal.appendChild(li);
        });

        totalModal.textContent = `$${total.toFixed(2)}`;
    }
    
    resumenModal.style.display = 'block'; // Mostrar el modal
}

// LÃ³gica para cerrar el Modal
closeButton.addEventListener('click', () => {
    resumenModal.style.display = 'none';
});


//segunda version
// ...existing code...

cerrarYConfirmarButton.addEventListener('click', async () => {
  if (pedidoActual.length === 0) {
    alert('El pedido estÃ¡ vacÃ­o. No hay nada que confirmar.');
    resumenModal.style.display = 'none';
    return;
  }  
  const idMesa = document.getElementById('selectMesa').value;

  let total=0;
  const productosParaDB = pedidoActual.map(item => {
        const precioNumero = parseFloat(item.precio.replace('Precio: $', '').trim());
        const subtotal = precioNumero * item.cantidad;
        total += subtotal;

        return {
            id: item.idProducto, 
            cantidad: item.cantidad,
            subtotal: parseFloat(subtotal.toFixed(2))
        };
    });
    // Construir el objeto principal del pedido
    const pedidoData = {
        // ğŸš¨ IdCliente: Se toma de la selecciÃ³n de Mesa
        idCliente: parseInt(idMesa, 10), 
        // IdUsuario: Se toma de la sesiÃ³n de Login
        idUsuario: parseInt(localStorage.getItem('usuarioId') || '1', 10), 
        total: parseFloat(total.toFixed(2)),
        productos: productosParaDB
    };
    
    // ValidaciÃ³n de seguridad (opcional pero recomendada)
    if (isNaN(pedidoData.idUsuario)) {
        alert('Error: No se pudo identificar al empleado (ID de usuario no encontrado).');
        return;
    }

    try {
        const response = await fetch('http://localhost:3000/api/pedidos', {
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(pedidoData) 
        });

        const data = await response.json();

        if (response.ok && data.success) {
            // Ã‰xito: El backend se encargÃ³ de las tablas Pedidos y DetallePedidos.
            alert(`âœ… Pedido #${data.idPedido} (Mesa ${idMesa}) guardado con Ã©xito.`);
            
            // Limpieza y cierre
            pedidoActual = []; 
            document.querySelectorAll('.producto-cantidad').forEach(input => { input.value = 0; });
            resumenModal.style.display = 'none';
        } else {
            alert(`âŒ Error al guardar el pedido: ${data.message || 'Error desconocido.'}`);
        }

    } catch (error) {
        console.error('Error de conexiÃ³n con el servidor:', error);
        alert('âŒ Error de conexiÃ³n. AsegÃºrate de que tu servidor (node server.js) estÃ© corriendo.');
    }
});
  /*resumenModal.style.display = 'none';
    alert('Pedido Finalizado y Confirmado.');
    pedidoActual = []; // Vaciar el pedido

    // Reiniciar los valores de cantidad en todas las tarjetas
    document.querySelectorAll('.producto-cantidad').forEach(input => {
        input.value = 0;
    });
});*/

// ...existing code...

// Cerrar modal si el usuario hace clic fuera de Ã©l
window.addEventListener('click', (event) => {
    if (event.target === resumenModal) {
        resumenModal.style.display = 'none';
    }
});
// LÃ³gica del nuevo botÃ³n "AÃ±adir MÃ¡s Productos" (Â¡NUEVO!)
seguirAgregandoButton.addEventListener('click', () => {
    resumenModal.style.display = 'none';
    // Importante: NO vaciamos el pedidoActual, solo cerramos el modal.
});
    //fin weas modal

    // Funcionalidad bÃ¡sica de botones
    const editButtons = document.querySelectorAll('.edit');
    const deleteButtons = document.querySelectorAll('.delete');
    const okButtons = document.querySelectorAll('.ok');

       //modificado
    okButtons.forEach(btn => {
Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  Â  // 1. Obtener la tarjeta padre para encontrar los datos
Â  Â  Â  Â  const card = btn.closest('.card');
Â  Â  Â  Â  
Â  Â  Â  Â  // 2. Extraer la informaciÃ³n usando las clases que aÃ±adimos
Â  Â  Â  Â  const idProducto= parseInt(card.dataset.id, 10); // Si necesitas el ID
        const nombreElement = card.querySelector('.producto-nombre');
Â  Â  Â  Â  const precioElement = card.querySelector('.producto-precio');
Â  Â  Â  Â  const cantidadInput = card.querySelector('.producto-cantidad');

        // ValidaciÃ³n: Asegurarse de que todos los elementos existan
        if (!nombreElement || !precioElement || !cantidadInput || !idProducto) {
            alert('Error: Faltan elementos de datos en la tarjeta (nombre/precio/cantidad).');
            return;
        }

Â  Â  Â  Â  const nombre = nombreElement.textContent.trim();
Â  Â  Â  Â  const precioTexto = precioElement.textContent.trim(); // Ej: "Precio: $45"
Â  Â  Â  Â  const cantidad = parseInt(cantidadInput.value, 10);
        
        // ValidaciÃ³n de cantidad
        if (cantidad < 1 || isNaN(cantidad)) {
            alert('La cantidad debe ser un nÃºmero positivo.');
            return;
        }

Â  Â  Â  Â  // 3. Crear el objeto producto
Â  Â  Â  Â  const producto = {
  Â  Â  Â    idProducto: idProducto,
Â  Â  Â  Â  Â  nombre: nombre,
Â  Â  Â  Â  Â  precio: precioTexto, 
Â  Â  Â  Â  Â  cantidad: cantidad
Â  Â  Â  Â  };

Â  Â  Â  Â  // 4. AÃ±adir o actualizar al pedido actual
        const itemExistente = pedidoActual.find(item => item.nombre === nombre);
        if (itemExistente) {
            // Si ya existe, SUMAR la cantidad actual (si el usuario la volviÃ³ a agregar)
            itemExistente.cantidad += cantidad;
        } else {
            // Si es un producto nuevo, lo aÃ±adimos
            pedidoActual.push(producto);
        }
        
        // 5. Mostrar el modal con el resumen del pedido
Â  Â  Â  Â  mostrarResumenPedido();
Â  Â  });
});
    //fin modificado
    //piwas version
    

editButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    // 1. Obtener la tarjeta padre
    const card = btn.closest('.card');
    const nombreElement = card.querySelector('.producto-nombre');
    const cantidadInput = card.querySelector('.producto-cantidad');

    if (!nombreElement || !cantidadInput) {
      alert('Error: No se encontrÃ³ el producto o cantidad.');
      return;
    }

    const nombre = nombreElement.textContent.trim();
    const nuevaCantidad = parseInt(cantidadInput.value, 10);

    if (isNaN(nuevaCantidad) || nuevaCantidad < 1) {
      alert('La cantidad debe ser mayor a 0.');
      return;
    }

    // 2. Buscar el producto en el pedidoActual y actualizar la cantidad
    const productoEnPedido = pedidoActual.find(item => item.nombre === nombre);
    if (productoEnPedido) {
      productoEnPedido.cantidad = nuevaCantidad;
      mostrarResumenPedido(); // Refresca el modal con la nueva cantidad
      alert('Cantidad actualizada en el resumen.');
    } else {
      alert('Este producto aÃºn no estÃ¡ en el pedido. ConfÃ­rmalo primero con âœ”.');
    }
  });
});

deleteButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    // 1. Obtener la tarjeta padre
    const card = btn.closest('.card');
    const nombreElement = card.querySelector('.producto-nombre');
    if (!nombreElement) {
      alert('Error: No se encontrÃ³ el producto.');
      return;
    }
    const nombre = nombreElement.textContent.trim();

    // 2. Eliminar del array pedidoActual
    const index = pedidoActual.findIndex(item => item.nombre === nombre);
    if (index !== -1) {
      pedidoActual.splice(index, 1); // Elimina el producto del pedido
      mostrarResumenPedido(); // Actualiza el modal
      alert('Producto eliminado del resumen.');
    } else {
      alert('Este producto no estÃ¡ en el pedido.');
    }
  });
});

  </script>
 
</body>
</html>
