<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Pedidos - Cafetería JAVA</title>
    <link rel="stylesheet" href="estilin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <header class="navbar">
        <h1><i class="fa-solid fa-mug-saucer" style="color: #ffffff;"></i> Cafetería JAVA</h1>
        <nav>
            <a href="Inicio.html">Inicio</a>
            <a href="Gestion de pedidos.html">Pedidos</a>
            <a href="Inventario/inventario_menu.html">Inventario</a>
            <a href="#" class="activo">Panel</a> 
            <a href="InicioSesion.html">Cerrar sesion</a>
        </nav>
    </header>

    <main class="container">
        <h2>Panel de Órdenes</h2>
        <div class="panel-layout">
            
            <section class="order-list-container">
                <h3>Lista de Pedidos Recientes</h3>
                <div class="order-row" style="font-weight: bold; background-color: #f0f0f0;">
                    <div>ID</div>
                    <div>Mesa</div>
                    <div>Fecha</div>
                    <div>Total</div>
                </div>
                <div id="orderList">
                    <p>Cargando pedidos...</p>
                </div>
            </section>

            <section class="order-detail-container">
                <h3 id="detailTitle">Detalle del Pedido</h3>
                <div id="orderDetailContent">
                    <p>Selecciona un pedido de la lista para ver los detalles.</p>
                </div>
            </section>

        </div>
    </main>

    <footer>
        <div class="footer-content">
      <p>© 2025 Cafetería JAVA. Todos los derechos reservados.</p>
      <div class="footer-links">
        <a href="politica_privacidad.html">Política de privacidad</a> |
        <a href="condiciones_servicio.html">Condiciones de servicio</a> |
        <a href="preguntas_frecuentes.html">Preguntas frecuentes</a>
      </div>
    </div>
        </footer>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
    const orderListDiv = document.getElementById('orderList');
    const orderDetailContent = document.getElementById('orderDetailContent');
    
    // Función para formatear la fecha a un formato legible
    const formatDate = (dateString) => {
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        return new Date(dateString).toLocaleDateString('es-MX', options);
    };

    // 1. CARGA LA LISTA DE PEDIDOS EN LA COLUMNA IZQUIERDA
    async function loadOrderList() {
        try {
            const response = await fetch('http://localhost:3000/api/pedidos');
            if (!response.ok) {
                throw new Error('Error al cargar la lista de pedidos');
            }
            const orders = await response.json();
            orderListDiv.innerHTML = ''; // Limpiar mensaje de carga

            orders.forEach(order => {
                const row = document.createElement('div');
                row.className = 'order-row';
                row.dataset.id = order.IdPedido; // Guardar el ID para el clic

                row.innerHTML = `
                    <div>#${order.IdPedido}</div>
                    <div>${order.NombreCliente}</div>
                    <div>${formatDate(order.Fecha)}</div>
                    <div>$${parseFloat(order.Total).toFixed(2)}</div>
                `;
                
                // 2. AÑADE EL EVENTO CLICK
                row.addEventListener('click', () => {
                    // Remover 'active' de todas las filas y añadirlo a la seleccionada
                    document.querySelectorAll('.order-row').forEach(r => r.classList.remove('active'));
                    row.classList.add('active');
                    showOrderDetail(order.IdPedido, order);
                });

                orderListDiv.appendChild(row);
            });
        } catch (error) {
            orderListDiv.innerHTML = `<p style="color: red;">Error: No se pudo conectar con el servidor de pedidos. (${error.message})</p>`;
        }
    }

    // 3. CARGA LOS DETALLES DEL PEDIDO EN LA COLUMNA DERECHA
    async function showOrderDetail(orderId, orderSummary) {
        orderDetailContent.innerHTML = '<p>Cargando detalles...</p>';
        try {
            // Llamar a la nueva ruta para obtener el detalle de productos
            const response = await fetch(`http://localhost:3000/api/pedidos/${orderId}/detalle`);
            if (!response.ok) {
                throw new Error('Error al cargar detalles');
            }
            const details = await response.json();

            let detailsHTML = `
              <h4>Pedido #${orderId}</h4>
        
                <p><strong>Mesa:</strong> ${orderSummary.NombreCliente}</p>
                <p><strong>Tomado por:</strong> ${orderSummary.NombreUsuario}</p>
                <hr>
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cant.</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            details.forEach(item => {
                detailsHTML += `
                    <tr>
                        <td>${item.NombreProducto}</td>
                        <td>x${item.Cantidad}</td>
                        <td>$${parseFloat(item.Subtotal).toFixed(2)}</td>
                    </tr>
                `;
            });
            
            detailsHTML += `
                    </tbody>
                </table>
                <hr>
                <p style="font-size: 1.2em; font-weight: bold; text-align: right;">TOTAL: $${parseFloat(orderSummary.Total).toFixed(2)}</p>
            `;

            orderDetailContent.innerHTML = detailsHTML;

        } catch (error) {
            orderDetailContent.innerHTML = `<p style="color: red;">Error al obtener detalles: ${error.message}</p>`;
        }
    }

    loadOrderList();
});
    </script> 
    </body>
</html>
